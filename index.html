<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KUBAMINER</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.js"></script>
  <script src='//libtl.com/sdk.js' data-zone='10111635' data-sdk='show_10111635'></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0f0f1a; color:#fff; font-family:Arial, sans-serif; text-align:center; padding:10px; overflow:hidden; }
    .container { max-width:400px; margin:auto; }
    .topbar { display:flex; justify-content:space-between; background:#1a1a2e; padding:10px 15px; border-radius:12px; margin-bottom:15px; font-size:14px; font-weight:bold; }
    .topbar .left { color:#ffd700; }
    .topbar .right { color:#4ade80; text-align:right; }
    h1 { font-size:24px; margin:10px 0; font-weight:bold; }
    .exchange-btn { background:#9c88ff; color:white; padding:12px; border-radius:12px; font-weight:bold; margin:10px auto; width:90%; }
    .bald { width:180px; height:180px; margin:20px auto; cursor:pointer; user-select:none; }
    .bald img { width:100%; height:100%; border-radius:50%; transition:0.2s; }
    .bald:active img { transform:scale(0.92); }
    .stats { display:flex; justify-content:space-around; margin:15px 0; font-size:14px; }
    .stat { background:#1a1a2e; padding:8px 12px; border-radius:8px; flex:1; margin:0 5px; }
    button { 
      background:#ffd700; color:#000; border:none; padding:12px 20px; 
      border-radius:12px; font-weight:bold; font-size:16px; margin:8px; width:90%;
      transition:0.2s;
    }
    button:active { transform:scale(0.98); }
    .upgrade-btn { background:#f39c12; color:white; }
    .refer-btn { background:#2ed573; color:#000; }
    .wallet-box { background:#1a1a2e; border:1px solid #FFD700; border-radius:12px; padding:12px; margin:10px 0; font-size:12px; word-break:break-all; }
    .particle { position:absolute; font-size:26px; pointer-events:none; animation:fly 1s ease-out forwards; font-weight:bold; }
    @keyframes fly { to { transform:translateY(-120px); opacity:0; } }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; overflow-y:auto; }
    .modal-content { background:#1a1a2e; margin:5% auto; padding:20px; width:90%; border-radius:16px; text-align:center; max-width:400px; }
    .swap-card { background:#0f0f1a; border-radius:16px; padding:20px; margin:15px 0; }
    .swap-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .swap-header h3 { font-size:18px; }
    .token-input { background:#1a1a2e; border-radius:12px; padding:15px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; }
    .token-input img { width:28px; height:28px; border-radius:50%; margin-right:10px; }
    .token-input input { background:none; border:none; color:#fff; font-size:20px; text-align:right; width:60%; }
    .token-balance { font-size:12px; color:#aaa; }
    .swap-arrow { font-size:24px; color:#aaa; margin:10px auto; }
    .swap-info { font-size:13px; color:#aaa; margin:15px 0; text-align:left; }
    .swap-info div { display:flex; justify-content:space-between; margin:4px 0; }
    .price-impact { color:#ff6b6b; }
    .dev-fee { color:#ffd700; }
    .swap-btn { background:#4ade80; color:white; font-weight:bold; padding:16px; border-radius:12px; margin:15px 0; font-size:18px; }
    .swap-btn:disabled { background:#555; cursor:not-allowed; }
    .settings-btn { background:#333; color:#aaa; padding:8px 12px; border-radius:8px; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="left">Points: <span id="pointsDisplay">0</span></div>
      <div class="right">Level: <span id="level">1</span></div>
    </div>

    <h1>KUBAMINER</h1>

    <button class="exchange-btn" onclick="openExchange()">SWAP HUB</button>

    <div class="bald" id="baldHead">
      <img id="baldImg" src="bald.png" alt="Tap" onerror="this.src='https://via.placeholder.com/300?text=TAP'" />
    </div>

    <div class="stats">
      <div class="stat">Energy: <span id="energy">100</span>/<span id="maxEnergy">100</span></div>
      <div class="stat">Tap: <span id="tapPower">1</span></div>
    </div>

    <div class="wallet-box" id="walletAddress">Wallet: Loading...</div>

    <button class="upgrade-btn" onclick="upgradeCharacter()">Upgrade (<span id="upgradeCost">500</span> Pts)</button>
    <button class="refer-btn" onclick="openReferralAd()">Claim Airdrop!</button>
    <button onclick="copyAddress()" style="background:#5f27cd; color:white;">Copy Wallet</button>
  </div>

  <!-- Uniswap-Style Swap Modal -->
  <div id="exchangeModal" class="modal">
    <div class="modal-content">
      <div class="swap-card">
        <div class="swap-header">
          <h3>Swap</h3>
          <button class="settings-btn" onclick="openSettings()">Settings</button>
        </div>

        <!-- From: POL -->
        <div class="token-input">
          <div><img src="https://cryptologos.cc/logos/polygon-matic-logo.png" alt="POL"> POL</div>
          <input type="number" id="fromAmount" placeholder="0.0" oninput="calculateSwap()">
          <div class="token-balance">Balance: <span id="polBalance">0.00</span></div>
        </div>

        <div class="swap-arrow">Down Arrow</div>

        <!-- To: KUBA -->
        <div class="token-input">
          <div><img src="https://via.placeholder.com/28?text=K" alt="KUBA"> KUBA</div>
          <div id="toAmount" style="font-size:20px; color:#4ade80;">0.00</div>
          <div class="token-balance">Balance: <span id="kubaBalance">0.00</span></div>
        </div>

        <!-- Swap Info -->
        <div class="swap-info">
          <div>Price <span id="price">Loading...</span></div>
          <div>Price Impact <span class="price-impact" id="priceImpact">0.00%</span></div>
          <div>Dev Fee (1%) <span class="dev-fee" id="devFee">0.00 KUBA</span></div>
          <div>Network Gas <span id="gasFee">~0.002 POL</span></div>
          <div>Slippage Tolerance <span id="slippage">0.5%</span></div>
        </div>

        <button class="swap-btn" id="swapButton" onclick="confirmSwap()" disabled>Enter Amount</button>
      </div>

      <button onclick="closeExchange()" style="background:#e74c3c; margin:10px;">Close</button>
    </div>
  </div>

  <script>
    // Variables
    let points = 0, kubaBalance = 0, polBalance = 0, energy = 100, maxEnergy = 100, tapPower = 1, level = 1;
    const MAX_LEVEL = 100;
    let wallet = null, provider = null;
    const CONTRACT_ADDRESS = '0x8eFc217Bb56e9081455171002F80b84737cB4468';
    const UNISWAP_ROUTER = '0xE592427A0AEce92De3Edee1F18E0157C05861564'; // QuickSwap (Polygon)
    const WPOL = '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270';
    const KUBA = '0x8eFc217Bb56e9081455171002F80b84737cB4468';
    let price = 0;

    // Load / Save
    function loadGame() {
      points = parseFloat(localStorage.getItem('kuba_points')) || 0;
      level = parseInt(localStorage.getItem('kuba_level')) || 1;
      tapPower = level; maxEnergy = level * 100; energy = Math.min(energy, maxEnergy);
      updateUI();
    }
    function saveGame() { localStorage.setItem('kuba_points', points); localStorage.setItem('kuba_level', level); }

    // Init
    async function initWallet() {
      loadGame();
      let pk = localStorage.getItem('kuba_private_key');
      if (!pk) { wallet = ethers.Wallet.createRandom(); localStorage.setItem('kuba_private_key', wallet.privateKey); alert('Wallet created!'); }
      else wallet = new ethers.Wallet(pk);
      document.getElementById('walletAddress').innerText = 'Wallet: ' + wallet.address.slice(0,8) + '...' + wallet.address.slice(-6);
      provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
      loadBalances(); setInterval(loadBalances, 10000);
      fetchPrice(); setInterval(fetchPrice, 15000);
    }

    // Fetch Real Price from Uniswap
    async function fetchPrice() {
      try {
        const router = new ethers.Contract(UNISWAP_ROUTER, [
          "function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)"
        ], provider);
        const amountIn = ethers.utils.parseUnits("1", 18); // 1 POL
        const path = [WPOL, KUBA];
        const amounts = await router.getAmountsOut(amountIn, path);
        price = parseFloat(ethers.utils.formatUnits(amounts[1], 18));
        document.getElementById('price').innerText = `1 POL = ${price.toFixed(6)} KUBA`;
      } catch { document.getElementById('price').innerText = "Price unavailable"; }
    }

    // Load Balances
    async function loadBalances() {
      try { const b = await provider.getBalance(wallet.address); polBalance = parseFloat(ethers.utils.formatEther(b)).toFixed(4); } catch { polBalance = '0.00'; }
      try { const c = new ethers.Contract(KUBA, ["function balanceOf(address) view returns (uint256)"], provider); const b = await c.balanceOf(wallet.address); kubaBalance = parseFloat(ethers.utils.formatUnits(b, 18)).toFixed(2); } catch { kubaBalance = '0.00'; }
      updateUI(); updateSwapUI();
    }

    // Swap Calculation
    function calculateSwap() {
      const amt = parseFloat(document.getElementById('fromAmount').value) || 0;
      if (amt <= 0 || !price) { document.getElementById('swapButton').disabled = true; return; }
      const output = amt * price;
      const devFee = output * 0.01;
      const final = output - devFee;
      document.getElementById('toAmount').innerText = final.toFixed(6);
      document.getElementById('devFee').innerText = devFee.toFixed(6) + ' KUBA';
      document.getElementById('swapButton').disabled = false;
      document.getElementById('swapButton').innerText = 'Swap';
    }

    // UI
    function updateUI() {
      document.getElementById('pointsDisplay').innerText = points.toLocaleString();
      document.getElementById('level').innerText = level;
      document.getElementById('energy').innerText = energy;
      document.getElementById('maxEnergy').innerText = maxEnergy;
      document.getElementById('tapPower').innerText = tapPower;
      const cost = level >= MAX_LEVEL ? 'MAX' : (level === 99 ? 1500000 : 500 + level * 15000).toLocaleString();
      document.getElementById('upgradeCost').innerText = cost;
    }
    function updateSwapUI() {
      document.getElementById('polBalance').innerText = polBalance;
      document.getElementById('kubaBalance').innerText = kubaBalance;
    }

    // Modals
    function openExchange() { document.getElementById('exchangeModal').style.display = 'block'; updateSwapUI(); calculateSwap(); }
    function closeExchange() { document.getElementById('exchangeModal').style.display = 'none'; }
    function openSettings() { alert('Slippage: 0.5% (Default)'); }

    // Swap
    async function confirmSwap() {
      alert('Swap via Uniswap + 1% Dev Fee (Dev Wallet: Coming Soon)');
      closeExchange();
    }

    // Tap & Upgrade
    document.getElementById('baldHead').addEventListener('click', () => {
      if (energy <= 0) return;
      energy--; points += tapPower; createParticle('+' + tapPower); saveGame(); updateUI();
      if (energy === 0) regenerateEnergy();
    });
    function upgradeCharacter() {
      if (level >= MAX_LEVEL) { alert('MAX LEVEL!'); return; }
      const cost = level === 99 ? 1500000 : 500 + level * 15000;
      if (points < cost) { alert(`Need ${cost.toLocaleString()} Points!`); return; }
      points -= cost; level++; tapPower = level; maxEnergy = level * 100; saveGame(); updateUI();
    }

    // Utils
    function createParticle(t) { const p = document.createElement('div'); p.className = 'particle'; p.innerText = t; p.style.left = Math.random()*80+10+'%'; p.style.top='40%'; document.body.appendChild(p); setTimeout(() => p.remove(), 1000); }
    function regenerateEnergy() { const i = setInterval(() => { if (energy < maxEnergy) { energy++; updateUI(); } else clearInterval(i); }, 1000); }
    function copyAddress() { navigator.clipboard.writeText(wallet.address); alert('Copied!'); }
    function openReferralAd() { window.open('https://sunantongsan.github.io/kuba-game/share-ad.html', '_blank'); }

    // Start
    Telegram.WebApp.ready(); Telegram.WebApp.expand(); initWallet(); regenerateEnergy();
  </script>
</body>
</html>