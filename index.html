<!-- === ส่วนแสดงผลและปุ่มแลกเปลี่ยน === -->
<div id="exchangeSection" style="margin: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px; display: none;">
  <h3>แลก KUBA</h3>
  <p>กระเป๋า: <span id="userWallet">ยังไม่ได้เชื่อมต่อ</span></p>
  <p>แต้มปัจจุบัน: <span id="userPoints">0</span></p>

  <select id="exchangeDirection">
    <option value="points_to_kuba">แต้ม → KUBA</option>
    <option value="kuba_to_points">KUBA → แต้ม</option>
  </select>

  <input type="number" id="exchangeAmount" placeholder="กรอกจำนวน..." style="width: 100%; padding: 10px; margin: 10px 0;" min="0" step="any">

  <div id="exchangePreview" style="margin: 10px 0; padding: 10px; background: #e7f3ff; border-radius: 8px; display: none;"></div>

  <button onclick="confirmExchange()" style="background: #4CAF50; color: white; padding: 12px; border: none; border-radius: 8px; width: 100%; font-size: 16px;">
    ยืนยันการแลก
  </button>
  <div id="exchangeResult" style="margin-top: 10px;"></div>
</div>

<script>
// === ตั้งค่า ===
const POINTS_PER_KUBA = 10;
const MIN_POINTS_TO_EXCHANGE = 100000;
let userWallet = null;
let userPoints = 0; // ดึงจากเกมหรือ API

// Web3
let web3;
if (typeof window.ethereum !== 'undefined') {
  web3 = new Web3(window.ethereum);
}

// ดึงแต้มจากเกม (สมมุติว่ามีตัวแปรในเกม)
function loadUserData() {
  // ตัวอย่าง: ดึงจาก localStorage หรือตัวแปรเกม
  userPoints = parseInt(localStorage.getItem('playerPoints')) || 150000;
  document.getElementById('userPoints').innerText = userPoints.toLocaleString();
}

// เชื่อมต่อ MetaMask
async function connectWallet() {
  if (!web3) return alert("กรุณาติดตั้ง MetaMask");

  try {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    userWallet = accounts[0];
    document.getElementById('userWallet').innerText = userWallet.slice(0, 6) + '...' + userWallet.slice(-4);
    document.getElementById('exchangeSection').style.display = 'block';
    loadUserData();
  } catch (err) {
    alert("ปฏิเสธการเชื่อมต่อ");
  }
}

// ดูตัวอย่างการแลก
document.getElementById('exchangeAmount').addEventListener('input', function() {
  const amount = parseFloat(this.value) || 0;
  const dir = document.getElementById('exchangeDirection').value;
  const preview = document.getElementById('exchangePreview');

  if (amount <= 0) {
    preview.style.display = 'none';
    return;
  }

  let html = '';
  if (dir === 'points_to_kuba') {
    if (amount < MIN_POINTS_TO_EXCHANGE) {
      html = `<span style="color:red">ต้องใช้อย่างน้อย ${MIN_POINTS_TO_EXCHANGE.toLocaleString()} แต้ม</span>`;
    } else if (amount > userPoints) {
      html = `<span style="color:red">แต้มไม่พอ! มี ${userPoints.toLocaleString()}</span>`;
    } else {
      const kuba = Math.floor(amount / POINTS_PER_KUBA);
      html = `ได้ <strong>${kuba} KUBA</strong> (หัก ${amount.toLocaleString()} แต้ม)`;
    }
  } else {
    const points = Math.floor(amount * POINTS_PER_KUBA);
    // ตรวจ KUBA ในกระเป๋า (ถ้ามี contract)
    html = `ได้ <strong>${points.toLocaleString()} แต้ม</strong> (ใช้ ${amount} KUBA)`;
  }

  preview.innerHTML = html;
  preview.style.display = 'block';
});

// ยืนยันการแลก
async function confirmExchange() {
  const amount = parseFloat(document.getElementById('exchangeAmount').value);
  const dir = document.getElementById('exchangeDirection').value;
  const resultDiv = document.getElementById('exchangeResult');

  if (!amount || amount <= 0) return alert("กรอกจำนวน!");

  // ตรวจ POL
  if (!userWallet) return alert("กรุณาเชื่อมต่อกระเป๋าก่อน");
  const balance = await web3.eth.getBalance(userWallet);
  const pol = parseFloat(web3.utils.fromWei(balance, 'ether'));
  if (pol < 0.001) return alert("คุณต้องมี POL อย่างน้อย 0.001 เพื่อจ่าย Gas Fee!");

  if (dir === 'points_to_kuba') {
    if (amount < MIN_POINTS_TO_EXCHANGE) return alert(`ขั้นต่ำ ${MIN_POINTS_TO_EXCHANGE.toLocaleString()} แต้ม`);
    if (amount > userPoints) return alert("แต้มไม่พอ!");

    const kuba = Math.floor(amount / POINTS_PER_KUBA);
    if (!confirm(`แลก ${amount.toLocaleString()} แต้ม → ${kuba} KUBA?`)) return;

    // === เรียก Backend หรือ Smart Contract ===
    // ตัวอย่าง: ส่งไป API
    fetch('/exchange', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        wallet: userWallet,
        action: 'points_to_kuba',
        points: amount,
        kuba: kuba
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        userPoints -= amount;
        localStorage.setItem('playerPoints', userPoints);
        document.getElementById('userPoints').innerText = userPoints.toLocaleString();
        resultDiv.innerHTML = `<span style="color:green">สำเร็จ! ได้ ${kuba} KUBA</span>`;
      } else {
        resultDiv.innerHTML = `<span style="color:red">${data.error}</span>`;
      }
    });

  } else {
    // KUBA → แต้ม
    const points = Math.floor(amount * POINTS_PER_KUBA);
    if (!confirm(`ใช้ ${amount} KUBA → ได้ ${points.toLocaleString()} แต้ม?`)) return;

    // ต้องเผา KUBA ผ่าน contract (ถ้ามี)
    // หรือส่งไป backend
    resultDiv.innerHTML = `<span style="color:green">กำลังดำเนินการ...</span>`;

    fetch('/exchange', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        wallet: userWallet,
        action: 'kuba_to_points',
        kuba: amount,
        points: points
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        userPoints += points;
        localStorage.setItem('playerPoints', userPoints);
        document.getElementById('userPoints').innerText = userPoints.toLocaleString();
        resultDiv.innerHTML = `<span style="color:green">สำเร็จ! ได้ ${points.toLocaleString()} แต้ม</span>`;
      } else {
        resultDiv.innerHTML = `<span style="color:red">${data.error}</span>`;
      }
    });
  }
}

// เรียกตอนโหลดหน้า (ถ้าต้องการ)
window.onload = function() {
  // ถ้ามีปุ่มเชื่อมต่ออยู่แล้ว ให้ผูกฟังก์ชัน
  const connectBtn = document.querySelector('#connectWalletBtn'); // เปลี่ยน ID ตามไฟล์คุณ
  if (connectBtn) connectBtn.onclick = connectWallet;
};
</script>