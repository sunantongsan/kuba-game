<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KUBAMINER</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.js"></script>
  <script src='//libtl.com/sdk.js' data-zone='10111635' data-sdk='show_10111635'></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0f0f1a; color:#fff; font-family:Arial, sans-serif; text-align:center; padding:10px; overflow:hidden; }
    .container { max-width:400px; margin:auto; }
    .topbar { display:flex; justify-content:space-between; align-items:flex-start; padding:10px 0; font-size:14px; }
    .topbar .left { color:#ffd700; font-weight:bold; }
    .topbar .right { text-align:right; line-height:1.4; color:#aaa; font-size:12px; }

    h1 { font-size:28px; margin:15px 0; font-weight:bold; color:#ffd700; text-shadow:0 0 8px #ffd700; }
    
    button {
      background:none; color:#fff; border:none; 
      padding:14px; border-radius:16px; font-weight:bold; font-size:16px; 
      margin:10px auto; width:92%; transition:0.2s; display:block;
    }
    button:active { transform:scale(0.98); opacity:0.8; }
    .redeem-btn { color:#9c88ff; }
    .reward-btn { color:#ff6b6b; }
    .upgrade-btn { color:#f39c12; }
    .refer-btn { color:#2ed573; }

    .info { font-size:14px; margin:8px 0; color:#aaa; }
    .highlight { color:#ffd700; font-weight:bold; }
    .energy-text { color:#4ade80; font-weight:bold; }

    .bald { width:180px; height:180px; margin:25px auto; cursor:pointer; user-select:none; }
    .bald img { width:100%; height:100%; border-radius:50%; transition:0.2s; }
    .bald:active img { transform:scale(0.92); }

    .particle { position:absolute; font-size:26px; pointer-events:none; animation:fly 1s ease-out forwards; font-weight:bold; color:#ffd700; }
    @keyframes fly { to { transform:translateY(-120px); opacity:0; } }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:999; overflow-y:auto; }
    .modal-content { background:#1a1a2e; margin:5% auto; padding:20px; width:90%; border-radius:24px; text-align:center; max-width:400px; }
    
    .redeem-container { padding:20px; margin:15px 0; }
    .redeem-title { font-size:22px; color:#ffd700; margin-bottom:15px; text-shadow:0 0 8px #ffd700; }
    .contract-info { color:#aaa; font-size:12px; margin:10px 0; word-break:break-all; }
    .input-group { padding:16px; margin:10px 0; text-align:left; }
    .input-group input { background:none; border:none; color:#fff; font-size:24px; text-align:right; width:100%; }
    .input-group label { color:#aaa; font-size:14px; }
    .confirm-box { padding:16px; margin:15px 0; text-align:left; }
    .confirm-gas { color:#ff6b6b; font-weight:bold; }
    .btn-group { display:flex; gap:10px; }
    .btn-group button { flex:1; margin:0; padding:14px; border-radius:12px; font-weight:bold; }
    .close-btn { background:#e74c3c; margin:10px; padding:12px; border-radius:12px; font-size:14px; }
    .tx-info { padding:10px; margin:10px 0; font-size:12px; color:#4ade80; word-break:break-all; }
    .tx-info a { color:#4ade80; text-decoration:underline; }

    .balance-kuba { color:#ffd700; font-weight:bold; }
    .balance-pol { color:#9c88ff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="left">Points: <span class="highlight" id="pointsDisplay">0</span></div>
      <div class="right">
        <div>KUBA: <span class="balance-kuba" id="kubaBalance">0</span></div>
        <div>POL: <span class="balance-pol" id="polBalance">0</span></div>
      </div>
    </div>

    <h1>KUBAMINER</h1>

    <button class="redeem-btn" onclick="openExchange()">ถอน/ฝาก KUBA</button>
    <button class="reward-btn" id="rewardButton" onclick="showRewardChoice()">รับรางวัล</button>
    <div class="info" style="margin:0 0 15px 0;">Level: <span class="highlight" id="level">1</span></div>

    <div class="bald" id="baldHead">
      <img id="baldImg" src="bald.png" alt="Tap" onerror="this.src='https://via.placeholder.com/300?text=TAP'" />
    </div>

    <div class="info">
      พลังงาน: <span class="energy-text" id="energy">100</span> / <span id="maxEnergy">100</span>
    </div>

    <button class="upgrade-btn" onclick="upgradeCharacter()">อัปเกรด (<span id="upgradeCost">500</span> แต้ม)</button>
    <button class="refer-btn" onclick="openReferralAd()">รับ Airdrop!</button>
  </div>

  <!-- Exchange Modal -->
  <div id="exchangeModal" class="modal">
    <div class="modal-content">
      <div class="redeem-container">
        <h3 class="redeem-title">ถอน/ฝาก KUBA</h3>
        <div class="contract-info">
          <strong>Contract KUBA:</strong> <a href="https://polygonscan.com/address/0x8eFc217Bb56e9081455171002F80b84737cB4468" target="_blank">0x8eFc217Bb56e9081455171002F80b84737cB4468</a><br>
          <strong>ซื้อ KUBA:</strong> <a href="https://app.uniswap.org/#/swap?chain=polygon&inputCurrency=0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270&outputCurrency=0x8eFc217Bb56e9081455171002F80b84737cB4468" target="_blank">Uniswap</a><br>
          <strong>ค่า Gas ถอน:** 2x Gas เครือข่าย (จ่าย fee ผู้พัฒนาเกม)
        </div>
        
        <div style="display:flex; gap:10px; margin:15px 0;">
          <button class="deposit-btn" onclick="setMode('deposit')" style="flex:1; color:#4ade80;">ฝาก KUBA</button>
          <button class="redeem-btn" onclick="setMode('withdraw')" style="flex:1; color:#f39c12;">ถอน KUBA</button>
        </div>

        <div class="input-group">
          <label id="inputLabel">จำนวน KUBA</label>
          <input type="number" id="inputAmount" placeholder="1000" oninput="calculateGas()">
        </div>

        <div class="input-group">
          <label>ค่า Gas ประมาณ</label>
          <div style="font-size:28px; color:#ff6b6b; text-align:right;" id="gasEstimate">0 POL</div>
          <div style="font-size:14px; color:#aaa; text-align:right;">(ถอน = 2x Gas เครือข่าย)</div>
        </div>

        <div id="confirmSection" style="display:none;">
          <div class="confirm-box">
            <div>ยืนยันการถอน/ฝาก</div>
            <div style="margin:8px 0;">จำนวน: <span id="confirmAmount">0</span> KUBA</div>
            <div class="confirm-gas">ค่า Gas: <span id="confirmGas">0.02 POL</div>
          </div>
          <div class="btn-group">
            <button style="background:#4ade80; color:#fff; border:none;" onclick="executeExchange()">ยืนยัน</button>
            <button style="background:#e74c3c; color:#fff; border:none;" onclick="cancelExchange()">ยกเลิก</button>
          </div>
        </div>

        <button id="nextBtn" class="redeem-btn" onclick="checkAndShowConfirm()" disabled>ยืนยัน</button>
        <div id="txInfo" class="tx-info" style="display:none;">
          Tx: <a id="txLink" href="#" target="_blank">ดูบน PolygonScan</a>
        </div>
      </div>
      <button class="close-btn" onclick="closeExchange()">ปิด</button>
    </div>
  </div>

  <script>
    // Game Variables
    let points = 0, energy = 100, maxEnergy = 100, tapPower = 1, level = 1;
    const MAX_LEVEL = 100;
    let wallet = null, provider = null, signer = null, kubaContract = null;
    let isTapping = false, pendingReward = false;
    let exchangeMode = 'deposit'; // deposit or withdraw

    // Config
    const KUBA_ADDRESS = '0x8eFc217Bb56e9081455171002F80b84737cB4468';
    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function approve(address spender, uint256 amount) returns (bool)',
      'function transfer(address to, uint256 amount) returns (bool)'
    ];

    // Load / Save
    function loadGame() {
      points = parseFloat(localStorage.getItem('kuba_points')) || 0;
      level = parseInt(localStorage.getItem('kuba_level')) || 1;
      tapPower = level;
      maxEnergy = level * 100;
      energy = parseFloat(localStorage.getItem('kuba_energy')) || maxEnergy;
      energy = Math.min(energy, maxEnergy);
      updateUI();
    }
    function saveGame() { 
      localStorage.setItem('kuba_points', points); 
      localStorage.setItem('kuba_level', level); 
      localStorage.setItem('kuba_energy', energy);
    }

    // Init
    async function initWallet() {
      loadGame();
      provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
      let pk = localStorage.getItem('kuba_private_key');
      if (!pk) { 
        wallet = ethers.Wallet.createRandom(); 
        localStorage.setItem('kuba_private_key', wallet.privateKey); 
        alert('สร้าง Wallet แล้ว! ฝาก POL เพื่อจ่าย gas'); 
      } else wallet = new ethers.Wallet(pk, provider);
      signer = wallet.connect(provider);
      kubaContract = new ethers.Contract(KUBA_ADDRESS, ERC20_ABI, signer);
      regenerateEnergy();
      setupTap();
      updateBalances();
      setInterval(updateBalances, 10000);
    }

    // === BALANCE UPDATE ===
    async function updateBalances() {
      try {
        const kubaBal = await kubaContract.balanceOf(wallet.address);
        const polBal = await provider.getBalance(wallet.address);
        document.getElementById('kubaBalance').innerText = parseFloat(ethers.utils.formatUnits(kubaBal, 18)).toFixed(4);
        document.getElementById('polBalance').innerText = parseFloat(ethers.utils.formatEther(polBal)).toFixed(6);
      } catch (e) {
        document.getElementById('kubaBalance').innerText = '0';
        document.getElementById('polBalance').innerText = '0';
      }
    }

    // === EXCHANGE SYSTEM ===
    function openExchange() { 
      document.getElementById('exchangeModal').style.display = 'block'; 
      setMode('deposit');
    }
    function closeExchange() { 
      document.getElementById('exchangeModal').style.display = 'none'; 
      document.getElementById('txInfo').style.display = 'none';
    }

    function setMode(m) {
      exchangeMode = m;
      const isDeposit = m === 'deposit';
      document.getElementById('inputLabel').innerText = isDeposit ? 'จำนวน KUBA ที่จะฝาก' : 'จำนวน KUBA ที่จะถอน';
      document.getElementById('inputAmount').placeholder = isDeposit ? '1000' : '500';
      calculateGas();
    }

    function calculateGas() {
      const input = parseFloat(document.getElementById('inputAmount').value) || 0;
      if (exchangeMode === 'deposit') {
        document.getElementById('gasEstimate').innerText = '0.01 POL (เครือข่าย)';
      } else {
        const gasNetwork = 0.01;
        const gasDev = gasNetwork * 2;
        document.getElementById('gasEstimate').innerText = `${gasDev.toFixed(2)} POL (รวม fee ผู้พัฒนาเกม)`;
      }
    }

    async function checkAndShowConfirm() {
      const input = parseFloat(document.getElementById('inputAmount').value);
      if (input <= 0) return alert('กรุณาใส่จำนวน!');

      const kubaBal = await kubaContract.balanceOf(wallet.address);
      const polBal = await provider.getBalance(wallet.address);

      if (exchangeMode === 'deposit') {
        const neededKuba = ethers.utils.parseUnits(input.toString(), 18);
        if (kubaBal.lt(neededKuba)) return alert(`KUBA ไม่พอ! มี ${ethers.utils.formatUnits(kubaBal, 18)} KUBA`);
      } else {
        const neededKuba = ethers.utils.parseUnits(input.toString(), 18);
        if (kubaBal.lt(neededKuba)) return alert(`KUBA ไม่พอ! มี ${ethers.utils.formatUnits(kubaBal, 18)} KUBA`);

        const gasNetwork = 0.01;
        const gasDev = gasNetwork * 2;
        const polFloat = parseFloat(ethers.utils.formatEther(polBal));
        if (polFloat < gasDev) return alert(`POL ไม่พอ! ต้องการ ${gasDev.toFixed(2)} POL (รวม fee)`);
      }

      document.getElementById('confirmAmount').innerText = input.toLocaleString();
      document.getElementById('confirmUnit').innerText = exchangeMode === 'deposit' ? 'KUBA' : 'KUBA';
      document.getElementById('confirmGas').innerText = exchangeMode === 'deposit' ? '0.01 POL' : '0.02 POL (รวม fee)';
      document.getElementById('confirmSection').style.display = 'block';
      document.getElementById('nextBtn').style.display = 'none';
    }

    function cancelExchange() {
      document.getElementById('confirmSection').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'block';
    }

    async function executeExchange() {
      const input = parseFloat(document.getElementById('inputAmount').value);

      if (exchangeMode === 'deposit') {
        try {
          // Approve ก่อน
          await (await kubaContract.approve(wallet.address, ethers.utils.parseUnits(input.toString(), 18))).wait();
          // Transfer to game pool (wallet.address เป็น pool)
          const tx = await kubaContract.transfer(wallet.address, ethers.utils.parseUnits(input.toString(), 18));
          await tx.wait();
          alert(`ฝากสำเร็จ! +${input} KUBA ลงเกม`);
          updateBalances();
        } catch (e) { alert('ผิดพลาด: ' + e.message); }
      } else {
        try {
          const gasNetwork = 0.01;
          const gasDev = gasNetwork * 2;
          const tx = await kubaContract.transfer(wallet.address, ethers.utils.parseUnits(input.toString(), 18), {
            gasLimit: 100000, // Gas network
            value: ethers.utils.parseEther(gasDev.toString()) // Fee dev (ส่ง POL ไป fee wallet ถ้าต้องการ)
          });
          await tx.wait();
          alert(`ถอนสำเร็จ! -${input} KUBA (จ่าย ${gasDev.toFixed(2)} POL)`);
          updateBalances();
        } catch (e) { alert('ผิดพลาด: ' + e.message); }
      }
      closeExchange();
    }

    // === ฟังก์ชันอื่น ๆ (tap, reward, upgrade) ===
    // (คัดลอกจากโค้ดก่อนหน้า)

    // Start
    Telegram.WebApp.ready(); 
    Telegram.WebApp.expand(); 
    initWallet();
  </script>
</body>
</html>
