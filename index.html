<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KUBAMINER</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.js"></script>
  <!-- Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='10111635' data-sdk='show_10111635'></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0f0f1a; color:#fff; font-family:Arial, sans-serif; text-align:center; padding:10px; overflow:hidden; }
    .container { max-width:400px; margin:auto; }
    .topbar { display:flex; justify-content:space-between; padding:15px 0; font-weight:bold; }
    .topbar .left { color:#ffd700; font-size:16px; }
    .topbar .right { color:#4ade80; font-size:16px; }
    h1 { font-size:28px; margin:15px 0; font-weight:bold; color:#ffd700; text-shadow:0 0 8px #ffd700; }
    
    button {
      background:linear-gradient(135deg, #ffd700, #f39c12); color:#000; border:none; 
      padding:14px; border-radius:16px; font-weight:bold; font-size:16px; 
      margin:10px auto; width:92%; box-shadow:0 4px 10px rgba(255,215,0,0.3);
      transition:0.2s; display:block;
    }
    button:active { transform:scale(0.98); }
    .redeem-btn { background:linear-gradient(135deg, #9c88ff, #6c5ce7); color:white; }
    .reward-btn { background:linear-gradient(135deg, #ff6b6b, #ee5a52); color:white; }
    .upgrade-btn { background:linear-gradient(135deg, #f39c12, #e67e22); color:white; }
    .refer-btn { background:linear-gradient(135deg, #2ed573, #27ae60); color:white; }
    .copy-btn { background:linear-gradient(135deg, #5f27cd, #4834d4); color:white; font-size:14px; }

    .info { font-size:14px; margin:8px 0; color:#aaa; }
    .highlight { color:#ffd700; font-weight:bold; }
    .energy-text { color:#4ade80; font-weight:bold; }

    .bald { width:180px; height:180px; margin:25px auto; cursor:pointer; user-select:none; }
    .bald img { width:100%; height:100%; border-radius:50%; transition:0.2s; box-shadow:0 0 20px rgba(255,215,0,0.4); }
    .bald:active img { transform:scale(0.92); }

    .particle { position:absolute; font-size:26px; pointer-events:none; animation:fly 1s ease-out forwards; font-weight:bold; color:#ffd700; }
    @keyframes fly { to { transform:translateY(-120px); opacity:0; } }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:999; overflow-y:auto; }
    .modal-content { background:#1a1a2e; margin:5% auto; padding:20px; width:90%; border-radius:24px; text-align:center; max-width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
    
    /* Redeem UI */
    .redeem-container { background:#0f0f1a; border-radius:20px; padding:20px; margin:15px 0; border:2px solid #ffd700; box-shadow:0 0 20px rgba(255,215,0,0.2); }
    .redeem-title { font-size:22px; color:#ffd700; margin-bottom:15px; text-shadow:0 0 8px #ffd700; }
    
    .input-group { background:#1a1a2e; border-radius:16px; padding:16px; margin:10px 0; text-align:left; border:1px solid #333; }
    .input-group input { background:none; border:none; color:#fff; font-size:24px; text-align:right; width:60%; }
    .input-group label { color:#aaa; font-size:14px; }
    .fee-info { font-size:12px; color:#ff6b6b; margin:5px 0; text-align:left; }
    .redeem-btn { background:linear-gradient(135deg, #4ade80, #27ae60); color:white; font-weight:bold; padding:16px; border-radius:16px; margin:15px 0; font-size:18px; width:100%; box-shadow:0 4px 15px rgba(74,222,128,0.4); }
    .redeem-btn:disabled { background:#555; }
    .redeem-btn.loading { animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.05); } }

    .close-btn { background:#e74c3c; margin:10px; padding:12px; border-radius:12px; font-size:14px; }

    .tx-info { background:#1a1a2e; border-radius:12px; padding:10px; margin:10px 0; font-size:12px; color:#4ade80; word-break:break-all; }
    .tx-info a { color:#4ade80; text-decoration:underline; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="left">Points: <span class="highlight" id="pointsDisplay">0</span></div>
      <div class="right">Level: <span class="highlight" id="level">1</span></div>
    </div>

    <h1>KUBAMINER</h1>

    <button class="redeem-btn" onclick="openRedeem()">Redeem KUBA (100K+ Points)</button>
    <button class="reward-btn" id="rewardButton" onclick="showRewardChoice()">Get Rewards: Points, Energy</button>
    <div id="rewardCooldown" class="info">Ready</div>

    <div class="bald" id="baldHead">
      <img id="baldImg" src="bald.png" alt="Tap" onerror="this.src='https://via.placeholder.com/300?text=TAP'" />
    </div>

    <div class="info">
      Energy: <span class="energy-text" id="energy">100</span> / <span id="maxEnergy">100</span>
    </div>
    <div class="info">
      Tap: <span class="highlight" id="tapPower">1</span> Points
    </div>

    <div style="background:#1a1a2e; border:1px solid #FFD700; border-radius:12px; padding:10px; margin:15px 0; font-size:12px; word-break:break-all;">
      Wallet: <span id="walletAddress">Loading...</span>
    </div>

    <button class="upgrade-btn" onclick="upgradeCharacter()">Upgrade (<span id="upgradeCost">500</span> Pts)</button>
    <button class="refer-btn" onclick="openReferralAd()">Claim Airdrop!</button>
    <button class="copy-btn" onclick="copyAddress()">Copy Wallet</button>
  </div>

  <!-- Redeem Modal -->
  <div id="redeemModal" class="modal">
    <div class="modal-content">
      <div class="redeem-container">
        <h3 class="redeem-title">Redeem Points → KUBA</h3>
        <div class="input-group">
          <label>Points (Min: 100,000)</label>
          <input type="number" id="pointsToRedeem" placeholder="100000" oninput="calculateRedeem()" min="100000" step="10000">
        </div>
        <div class="input-group">
          <label>You Receive</label>
          <div style="font-size:28px; color:#4ade80; text-align:right;" id="kubaAmount">0</div>
          <div style="font-size:14px; color:#aaa; text-align:right;">KUBA</div>
        </div>
        <div class="fee-info">
          Rate: 10 Points = 1 KUBA<br>
          Gas Fee: <span id="gasFee">0.01</span> POL (you pay)<br>
          Excess 0.009 POL → Liquidity: 0x34d2...3454e<br>
          <span style="color:#ffd700;">Transaction Required</span>
        </div>
        <button class="redeem-btn" id="redeemButton" onclick="confirmRedeem()" disabled>Claim KUBA</button>
        <div id="txInfo" class="tx-info" style="display:none;">
          Tx: <a id="txLink" href="#" target="_blank">View on PolygonScan</a>
        </div>
      </div>
      <button class="close-btn" onclick="closeRedeem()">Close</button>
    </div>
  </div>

  <!-- Reward Modal -->
  <div id="rewardModal" class="modal">
    <div class="modal-content">
      <h3 style="color:#ffd700; margin-bottom:15px;">เลือกของรางวัล!</h3>
      <div style="margin:15px 0; font-size:16px; color:#fff;">
        ดูโฆษณาเสร็จแล้ว! รับรางวัลอย่างใดอย่างหนึ่ง:
      </div>
      <button onclick="claimPointsReward()" style="background:#4ade80; margin:10px; padding:14px; border-radius:12px; font-weight:bold; font-size:16px;">
        รับ <span id="pointsRewardAmount">300</span> แต้ม
      </button>
      <button onclick="claimEnergyReward()" style="background:#f39c12; margin:10px; padding:14px; border-radius:12px; font-weight:bold; font-size:16px;">
        รับพลังงาน 50%
      </button>
      <button onclick="closeRewardModal()" style="background:#e74c3c; margin:10px; padding:12px; border-radius:12px;">ยกเลิก</button>
    </div>
  </div>

  <script>
    // Game Variables
    let points = 0, energy = 100, maxEnergy = 100, tapPower = 1, level = 1;
    const MAX_LEVEL = 100;
    let wallet = null, provider = null, signer = null;
    let isTapping = false;
    let pendingReward = false;

    // === REDEEM CONFIG (ตามคำขอจริง) ===
    const POINTS_PER_KUBA = 10;           // 10 แต้ม = 1 KUBA
    const MIN_POINTS_TO_REDEEM = 100000;  // ขั้นต่ำ 100,000 แต้ม
    const GAS_FEE_POL = 0.01;             // ผู้เล่นจ่าย
    const EXCESS_TO_LIQUIDITY = 0.009;    // โอนไป wallet liquidity
    const LIQUIDITY_WALLET = '0x34d27165382fdc48b468e5deb617ea1018e3454e';

    // KUBA Contract
    const KUBA_ADDRESS = '0x8eFc217Bb56e9081455171002F80b84737cB4468';
    const ERC20_ABI = [
      'function transfer(address to, uint256 amount) public returns (bool)',
      'function balanceOf(address owner) view returns (uint256)'
    ];

    // Load / Save
    function loadGame() {
      points = parseFloat(localStorage.getItem('kuba_points')) || 0;
      level = parseInt(localStorage.getItem('kuba_level')) || 1;
      tapPower = level;
      maxEnergy = level * 100;
      energy = parseFloat(localStorage.getItem('kuba_energy')) || maxEnergy;
      energy = Math.min(energy, maxEnergy);
      updateUI();
    }
    function saveGame() { 
      localStorage.setItem('kuba_points', points); 
      localStorage.setItem('kuba_level', level); 
      localStorage.setItem('kuba_energy', energy);
    }

    // Init Wallet
    async function initWallet() {
      loadGame();
      provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
      let pk = localStorage.getItem('kuba_private_key');
      if (!pk) { 
        wallet = ethers.Wallet.createRandom(); 
        localStorage.setItem('kuba_private_key', wallet.privateKey); 
        alert('Wallet created! Add POL for gas to redeem.'); 
      } else wallet = new ethers.Wallet(pk, provider);
      signer = wallet.connect(provider);
      document.getElementById('walletAddress').innerText = wallet.address.slice(0,8) + '...' + wallet.address.slice(-6);
      regenerateEnergy();
    }

    // === REDEEM SYSTEM ===
    function openRedeem() { 
      document.getElementById('redeemModal').style.display = 'block'; 
      calculateRedeem(); 
    }
    function closeRedeem() { 
      document.getElementById('redeemModal').style.display = 'none'; 
      document.getElementById('txInfo').style.display = 'none';
    }

    function calculateRedeem() {
      const pointsInput = parseFloat(document.getElementById('pointsToRedeem').value) || 0;
      const kubaAmount = Math.floor(pointsInput / POINTS_PER_KUBA);

      if (pointsInput < MIN_POINTS_TO_REDEEM || pointsInput > points || pointsInput % POINTS_PER_KUBA !== 0) {
        document.getElementById('redeemButton').disabled = true;
        document.getElementById('kubaAmount').innerText = '0';
        return;
      }

      document.getElementById('kubaAmount').innerText = kubaAmount.toLocaleString();
      document.getElementById('gasFee').innerText = GAS_FEE_POL;
      document.getElementById('redeemButton').disabled = false;
      document.getElementById('redeemButton').innerText = `Claim ${kubaAmount.toLocaleString()} KUBA`;
    }

    async function confirmRedeem() {
      const pointsInput = parseFloat(document.getElementById('pointsToRedeem').value);
      const kubaAmount = Math.floor(pointsInput / POINTS_PER_KUBA);
      const btn = document.getElementById('redeemButton');
      btn.disabled = true;
      btn.innerText = 'Processing...';
      btn.classList.add('loading');

      try {
        if (points >= pointsInput && pointsInput >= MIN_POINTS_TO_REDEEM) {
          // หักแต้ม
          points -= pointsInput;
          saveGame();
          updateUI();

          // On-chain: Transfer KUBA
          const kubaContract = new ethers.Contract(KUBA_ADDRESS, ERC20_ABI, signer);
          const amount = ethers.utils.parseUnits(kubaAmount.toString(), 18);
          const tx = await kubaContract.transfer(wallet.address, amount, { gasLimit: 100000 });
          const receipt = await tx.wait();

          // Simulate excess POL to liquidity (optional, real backend)
          // await signer.sendTransaction({ to: LIQUIDITY_WALLET, value: ethers.utils.parseUnits('0.009', 18) });

          alert(`Success! +${kubaAmount.toLocaleString()} KUBA sent!\nGas: ~0.01 POL (you paid)`);

          document.getElementById('txInfo').style.display = 'block';
          document.getElementById('txLink').href = `https://polygonscan.com/tx/${receipt.transactionHash}`;
          document.getElementById('txLink').innerText = receipt.transactionHash.slice(0,10) + '...';
        }
      } catch (error) {
        alert(`Failed: ${error.message}\nMake sure you have POL for gas!`);
      }

      btn.disabled = false;
      btn.innerText = 'Claim KUBA';
      btn.classList.remove('loading');
    }

    // Reward, Tap, Upgrade, Utils (เหมือนเดิม)
    // ... (ย่อเพื่อความกระชับ - ใช้โค้ดเดิมจากก่อนหน้า)

    // Start
    Telegram.WebApp.ready(); 
    Telegram.WebApp.expand(); 
    initWallet();
  </script>
</body>
</html>
