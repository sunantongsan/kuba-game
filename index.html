<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KUBAMINER</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.js"></script>
  <!-- Monetag SDK - โฆษณาจริง -->
  <script src='//libtl.com/sdk.js' data-zone='10111635' data-sdk='show_10111635'></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0f0f1a; color:#fff; font-family:Arial, sans-serif; text-align:center; padding:10px; overflow:hidden; }
    .container { max-width:400px; margin:auto; }
    .topbar { display:flex; justify-content:space-between; padding:15px 0; font-weight:bold; }
    .topbar .left { color:#ffd700; font-size:16px; }
    .topbar .right { color:#4ade80; font-size:16px; }
    h1 { font-size:28px; margin:15px 0; font-weight:bold; color:#ffd700; text-shadow:0 0 8px #ffd700; }
    
    button {
      background:linear-gradient(135deg, #ffd700, #f39c12); color:#000; border:none; 
      padding:14px; border-radius:16px; font-weight:bold; font-size:16px; 
      margin:10px auto; width:92%; box-shadow:0 4px 10px rgba(255,215,0,0.3);
      transition:0.2s; display:block;
    }
    button:active { transform:scale(0.98); }
    .exchange-btn { background:linear-gradient(135deg, #9c88ff, #6c5ce7); color:white; }
    .reward-btn { background:linear-gradient(135deg, #ff6b6b, #ee5a52); color:white; }
    .upgrade-btn { background:linear-gradient(135deg, #f39c12, #e67e22); color:white; }
    .refer-btn { background:linear-gradient(135deg, #2ed573, #27ae60); color:white; }
    .copy-btn { background:linear-gradient(135deg, #5f27cd, #4834d4); color:white; font-size:14px; }

    .info { font-size:14px; margin:8px 0; color:#aaa; }
    .highlight { color:#ffd700; font-weight:bold; }
    .energy-text { color:#4ade80; font-weight:bold; }

    .bald { width:180px; height:180px; margin:25px auto; cursor:pointer; user-select:none; }
    .bald img { width:100%; height:100%; border-radius:50%; transition:0.2s; box-shadow:0 0 20px rgba(255,215,0,0.4); }
    .bald:active img { transform:scale(0.92); }

    .particle { position:absolute; font-size:26px; pointer-events:none; animation:fly 1s ease-out forwards; font-weight:bold; color:#ffd700; }
    @keyframes fly { to { transform:translateY(-120px); opacity:0; } }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; overflow-y:auto; }
    .modal-content { background:#1a1a2e; margin:5% auto; padding:20px; width:90%; border-radius:20px; text-align:center; max-width:400px; }
    .swap-card { background:#0f0f1a; border-radius:16px; padding:20px; margin:15px 0; border:2px solid #ffd700; }
    .token-input { background:#1a1a2e; border-radius:12px; padding:15px; margin:8px 0; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .token-input img { width:28px; height:28px; border-radius:50%; margin-right:10px; }
    .token-input input { background:none; border:none; color:#fff; font-size:20px; text-align:right; width:60%; }
    .swap-arrow { font-size:24px; color:#ffd700; margin:10px auto; }
    .swap-info { font-size:14px; color:#aaa; margin:15px 0; text-align:left; }
    .swap-info div { display:flex; justify-content:space-between; margin:4px 0; }
    .swap-btn { background:#4ade80; color:white; font-weight:bold; padding:16px; border-radius:12px; margin:15px 0; font-size:18px; }
    .swap-btn:disabled { background:#555; }
    .token-list { background:#1a1a2e; border-radius:12px; padding:10px; margin:10px 0; max-height:200px; overflow-y:auto; }
    .token-item { display:flex; align-items:center; padding:12px; cursor:pointer; border-bottom:1px solid #333; font-weight:bold; }
    .token-item img { width:24px; height:24px; border-radius:50%; margin-right:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="left">Points: <span class="highlight" id="pointsDisplay">0</span></div>
      <div class="right">Level: <span class="highlight" id="level">1</span></div>
    </div>

    <h1>KUBAMINER</h1>

    <button class="exchange-btn" onclick="openExchange()">SWAP HUB</button>
    <button class="reward-btn" id="rewardButton" onclick="claimReward()">รางวัล</button>
    <div id="rewardCooldown" class="info">พร้อมใช้งาน</div>

    <div class="bald" id="baldHead">
      <img id="baldImg" src="bald.png" alt="Tap" onerror="this.src='https://via.placeholder.com/300?text=TAP'" />
    </div>

    <div class="info">
      พลังงาน: <span class="energy-text" id="energy">100</span> / <span id="maxEnergy">100</span>
    </div>
    <div class="info">
      แตะได้: <span class="highlight" id="tapPower">1</span> แต้ม
    </div>

    <div style="background:#1a1a2e; border:1px solid #FFD700; border-radius:12px; padding:10px; margin:15px 0; font-size:12px; word-break:break-all;">
      Wallet: <span id="walletAddress">Loading...</span>
    </div>

    <button class="upgrade-btn" onclick="upgradeCharacter()">อัปเกรด (<span id="upgradeCost">500</span> แต้ม)</button>
    <button class="refer-btn" onclick="openReferralAd()">รับ Airdrop!</button>
    <button class="copy-btn" onclick="copyAddress()">คัดลอก Wallet</button>
  </div>

  <!-- Swap Modal -->
  <div id="exchangeModal" class="modal">
    <div class="modal-content">
      <div class="swap-card">
        <h3 style="color:#ffd700; margin-bottom:15px;">SWAP</h3>
        <div class="token-input" onclick="openTokenList('from')">
          <div id="fromTokenDisplay"><img src="https://cryptologos.cc/logos/polygon-matic-logo.png" alt="POL"> POL</div>
          <input type="number" id="fromAmount" placeholder="0.0" oninput="calculateSwap()">
        </div>
        <div class="swap-arrow">Down Arrow</div>
        <div class="token-input" onclick="openTokenList('to')">
          <div id="toTokenDisplay"><img src="https://via.placeholder.com/28?text=K" alt="KUBA"> KUBA</div>
          <div id="toAmount" style="font-size:20px; color:#4ade80;">0.00</div>
        </div>
        <div class="swap-info">
          <div>คุณจะได้รับ <span id="receiveAmount">0.00</span> <span id="toSymbol">KUBA</span></div>
          <div>เครือข่าย <span id="network">Polygon</span></div>
        </div>
        <button class="swap-btn" id="swapButton" onclick="confirmSwap()" disabled>กรอกจำนวน</button>
      </div>
      <button onclick="closeExchange()" style="background:#e74c3c; margin:10px;">ปิด</button>
    </div>
  </div>

  <!-- Token List -->
  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <h3 style="color:#ffd700;">เลือกเหรียญ</h3>
      <div class="token-list">
        <div class="token-item" onclick="selectToken('POL')"><img src="https://cryptologos.cc/logos/polygon-matic-logo.png" alt="POL"> POL</div>
        <div class="token-item" onclick="selectToken('KUBA')"><img src="https://via.placeholder.com/24?text=K" alt="KUBA"> KUBA</div>
        <div class="token-item" onclick="selectToken('TON')"><img src="https://cryptologos.cc/logos/ton-toncoin-logo.png" alt="TON"> TON</div>
      </div>
      <button onclick="closeTokenList()" style="background:#e74c3c; margin:10px;">ยกเลิก</button>
    </div>
  </div>

  <script>
    // ตัวแปรเกม
    let points = 0, energy = 100, maxEnergy = 100, tapPower = 1, level = 1;
    const MAX_LEVEL = 100;
    let wallet = null, provider = null;
    let rewardCooldown = 0;
    const REWARD_COOLDOWN = 30; // วินาที

    // โหลด / บันทึก
    function loadGame() {
      points = parseFloat(localStorage.getItem('kuba_points')) || 0;
      level = parseInt(localStorage.getItem('kuba_level')) || 1;
      tapPower = level; maxEnergy = level * 100; energy = Math.min(energy, maxEnergy);
      updateUI();
    }
    function saveGame() { localStorage.setItem('kuba_points', points); localStorage.setItem('kuba_level', level); }

    // สร้าง Wallet
    async function initWallet() {
      loadGame();
      let pk = localStorage.getItem('kuba_private_key');
      if (!pk) { wallet = ethers.Wallet.createRandom(); localStorage.setItem('kuba_private_key', wallet.privateKey); alert('สร้าง Wallet แล้ว!'); }
      else wallet = new ethers.Wallet(pk);
      document.getElementById('walletAddress').innerText = wallet.address.slice(0,8) + '...' + wallet.address.slice(-6);
      provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
      updateTokenDisplay();
      startRewardCooldown();
    }

    // ระบบรางวัลจากโฆษณา (Monetag)
    function startRewardCooldown() {
      const btn = document.getElementById('rewardButton');
      const cd = document.getElementById('rewardCooldown');
      const interval = setInterval(() => {
        if (rewardCooldown > 0) {
          rewardCooldown--;
          btn.disabled = true;
          cd.innerText = `รอ ${rewardCooldown} วินาที`;
        } else {
          btn.disabled = false;
          cd.innerText = 'พร้อมใช้งาน';
          clearInterval(interval);
        }
      }, 1000);
    }

    function claimReward() {
      const btn = document.getElementById('rewardButton');
      btn.disabled = true;
      document.getElementById('rewardCooldown').innerText = 'กำลังโหลดโฆษณา...';

      // เรียกโฆษณาจริงจาก Monetag
      show_10111635().then(() => {
        // ดูจบแล้ว → ให้รางวัล
        const energyReward = Math.floor(maxEnergy * 0.5);
        energy = Math.min(energy + energyReward, maxEnergy);
        points += 200;
        saveGame(); updateUI();
        alert(`โฆษณาจบแล้ว!\nได้รับพลังงาน +${energyReward}\nได้รับ +200 แต้ม!`);
        rewardCooldown = REWARD_COOLDOWN;
        startRewardCooldown();
      }).catch(() => {
        // ปิดโฆษณาเร็วเกินไป
        alert('กรุณาดูโฆษณาจบเพื่อรับรางวัล');
        btn.disabled = false;
        document.getElementById('rewardCooldown').innerText = 'พร้อมใช้งาน';
      });
    }

    // ระบบ Swap
    let fromToken = 'POL', toToken = 'KUBA', selecting = '';
    const tokens = {
      POL: { name: 'POL', img: 'https://cryptologos.cc/logos/polygon-matic-logo.png' },
      KUBA: { name: 'KUBA', img: 'https://via.placeholder.com/28?text=K' },
      TON: { name: 'TON', img: 'https://cryptologos.cc/logos/ton-toncoin-logo.png' }
    };

    function openTokenList(type) { selecting = type; document.getElementById('tokenModal').style.display = 'block'; }
    function closeTokenList() { document.getElementById('tokenModal').style.display = 'none'; }
    function selectToken(token) {
      if (selecting === 'from') fromToken = token;
      else toToken = token;
      updateTokenDisplay(); calculateSwap(); closeTokenList();
    }
    function updateTokenDisplay() {
      document.getElementById('fromTokenDisplay').innerHTML = `<img src="${tokens[fromToken].img}" alt="${fromToken}"> ${fromToken}`;
      document.getElementById('toTokenDisplay').innerHTML = `<img src="${tokens[toToken].img}" alt="${toToken}"> ${toToken}`;
      document.getElementById('toSymbol').innerText = toToken;
    }

    function calculateSwap() {
      const amt = parseFloat(document.getElementById('fromAmount').value) || 0;
      if (amt <= 0) { document.getElementById('swapButton').disabled = true; return; }

      let rate = 0;
      if (fromToken === 'POL' && toToken === 'KUBA') rate = 0.1;
      else if (fromToken === 'KUBA' && toToken === 'POL') rate = 10;
      else if (fromToken === 'POL' && toToken === 'TON') rate = 0.05;
      else if (fromToken === 'TON' && toToken === 'POL') rate = 20;
      else if (fromToken === 'KUBA' && toToken === 'TON') rate = 0.5;
      else if (fromToken === 'TON' && toToken === 'KUBA') rate = 2;

      const output = amt * rate * 0.99; // 1% หักเงียบ
      document.getElementById('toAmount').innerText = output.toFixed(6);
      document.getElementById('receiveAmount').innerText = output.toFixed(6);
      document.getElementById('network').innerText = (fromToken === 'TON' || toToken === 'TON') ? 'TON Bridge' : 'Polygon';
      document.getElementById('swapButton').disabled = false;
      document.getElementById('swapButton').innerText = 'แลกเปลี่ยน';
    }

    // อัปเดต UI
    function updateUI() {
      document.getElementById('pointsDisplay').innerText = points.toLocaleString();
      document.getElementById('level').innerText = level;
      document.getElementById('energy').innerText = energy;
      document.getElementById('maxEnergy').innerText = maxEnergy;
      document.getElementById('tapPower').innerText = tapPower;
      const cost = level >= MAX_LEVEL ? 'MAX' : (level === 99 ? 1500000 : 500 + level * 15000).toLocaleString();
      document.getElementById('upgradeCost').innerText = cost;
    }

    // Modal
    function openExchange() { document.getElementById('exchangeModal').style.display = 'block'; calculateSwap(); }
    function closeExchange() { document.getElementById('exchangeModal').style.display = 'none'; }
    function confirmSwap() {
      alert(`แลก ${document.getElementById('fromAmount').value} ${fromToken} → ${document.getElementById('toAmount').innerText} ${toToken}`);
      closeExchange();
    }

    // แตะตัวการ์ตูน
    document.getElementById('baldHead').addEventListener('click', () => {
      if (energy <= 0) return;
      energy--; points += tapPower; createParticle('+' + tapPower); saveGame(); updateUI();
      if (energy === 0) regenerateEnergy();
    });

    function upgradeCharacter() {
      if (level >= MAX_LEVEL) { alert('ถึงระดับสูงสุดแล้ว!'); return; }
      const cost = level === 99 ? 1500000 : 500 + level * 15000;
      if (points < cost) { alert(`ต้องการ ${cost.toLocaleString()} แต้ม!`); return; }
      points -= cost; level++; tapPower = level; maxEnergy = level * 100; saveGame(); updateUI();
    }

    // ฟังก์ชันเสริม
    function createParticle(t) { 
      const p = document.createElement('div'); 
      p.className = 'particle'; p.innerText = t; 
      p.style.left = Math.random()*80+10+'%'; p.style.top='40%'; 
      document.body.appendChild(p); 
      setTimeout(() => p.remove(), 1000); 
    }
    function regenerateEnergy() { 
      const i = setInterval(() => { 
        if (energy < maxEnergy) { energy++; updateUI(); } 
        else clearInterval(i); 
      }, 1000); 
    }
    function copyAddress() { navigator.clipboard.writeText(wallet.address); alert('คัดลอกแล้ว!'); }
    function openReferralAd() { window.open('https://sunantongsan.github.io/kuba-game/share-ad.html', '_blank'); }

    // เริ่มเกม
    Telegram.WebApp.ready(); Telegram.WebApp.expand(); 
    initWallet(); regenerateEnergy();
  </script>
</body>
</html>
